name: Smoke

on:
  pull_request:
    branches: ["main"]
  # 如果你启用了 merge queue，保留这一行更稳
  merge_group:

concurrency:
  group: smoke-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps (optional)
        shell: bash
        run: |
          python -m pip install -U pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "No requirements.txt, skip installing deps."
          fi

      - name: Syntax check (compile all .py)
        run: |
          python -m compileall -q .

      - name: Run entry script (optional)
        shell: bash
        run: |
          set -e

          entry=""

          # 1) Prefer main.py if it exists at repo root
          if [ -f "main.py" ]; then
            entry="main.py"
          else
            # 2) Otherwise, find a .py file at repo root (excluding common setup files)
            entry=$(find . -maxdepth 1 -type f -name "*.py" \
              ! -name "setup.py" ! -name "__init__.py" | head -n 1 || true)
          fi

          if [ -z "$entry" ]; then
            echo "No entry script found at repo root. Skip running."
            exit 0
          fi

          echo "Running smoke entry: $entry --help"
          python "$entry" --help
